{  
   "$schema":"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
   "contentVersion":"1.0.0.0",
   "parameters":{  
      "env_id":{  
         "defaultValue":"CldS",
         "type":"String"
      },
      "vnet_prefix":{  
         "defaultValue":"10.1",
         "type":"String"
      },
      "vaultName": {
            "type": "string",
            "defaultValue": "concat(parameters('env_id'),'SharedKeyV001')",
            "metadata": {
                "description": "The name of the keyvault that contains the secret."
            }
      },
      "vaultSecretName": {
            "type": "string",
            "defaultValue": "AdminPassword",
            "metadata": {
                "description": "The name of the secret."
            }
        },
      "vaultResourceGroupName": {
            "type": "string",
            "defaultValue": "[resourceGroup().name]",
            "metadata": {
                "description": "The name of the resource group that contains the keyvault."
            }
        }
   },
   "variables":{  

   },
   "resources":[  
      {  
         "apiVersion":"2018-02-01",
         "name":"linkedTemplateNetworks",
         "type":"Microsoft.Resources/deployments",
         "properties":{  
            "mode":"Incremental",
            "templateLink":{  
               "uri":"https://raw.githubusercontent.com/mariuszstrzelecki/szkolachmury/master/hw3/3.4/resources/networks.json",
               "contentVersion":"1.0.0.0"
            },
            "parameters":{  
               "env_id":{  
                  "value":"[parameters('env_id')]"
               },
               "vnet_prefix":{  
                  "value":"[parameters('vnet_prefix')]"
               }
            }
         }
      },
      {  
         "apiVersion":"2018-02-01",
         "name":"linkedTemplateVms",
         "type":"Microsoft.Resources/deployments",
         "properties":{  
            "mode":"Incremental",
            "templateLink":{  
               "uri":"https://raw.githubusercontent.com/mariuszstrzelecki/szkolachmury/master/hw3/3.4/resources/vms.json",
               "contentVersion":"1.0.0.0"
            },
            "parameters":{  
               "env_id":{  
                  "value":"[parameters('env_id')]"
               },
               "admin_password":{  
                  "reference": {
                        "keyVault": {
                                "id": "[resourceId(subscription().subscriptionId, parameters('vaultResourceGroupName'), 'Microsoft.KeyVault/vaults', parameters('vaultName'))]"
                            },
                            "secretName": "[parameters('vaultSecretName')]"
                        }
               }
            }
         },
         "dependsOn":[  
               "linkedTemplateNetworks"
            ]
      }
   ]
}
